package main

import (
	rbacv1 "k8s.io/api/rbac/v1"
)

// templateData is the struct with data to be used to properly render
// the Kubebuilder annotation files and the KIC RBAC files.
type templateData struct {
	Version    string
	Constraint string
	Roles      []*rbacv1.ClusterRole
}

// helperTemplateData is the struct with data to be used to properly render
// the file with helpers to retrieve the correct rbac generation function
type helperTemplateData struct {
	Versions map[string]string
}

const (
	controlplaneControllerRBACTemplate = `// This file is generated by /hack/generators/kic-clusterrole-generator. DO NOT EDIT.

package controllers

// -----------------------------------------------------------------------------
// Kong Ingress Controller - RBAC
// -----------------------------------------------------------------------------
{{ range .Roles }}
{{ range .Rules }}
//+kubebuilder:rbac:groups={{range .APIGroups}}{{if .}}{{. | join ";"}}{{else}}{{"core" | join ";"}}{{end}}{{end}},resources={{.Resources | join ";"}},verbs={{.Verbs | join ";"}}
{{- end }}
{{- end }}

`

	kicRBACTemplate = `// This file is generated by /hack/generators/kic-clusterrole-generator. DO NOT EDIT.

package clusterroles

import (
	"fmt"

	rbacv1 "k8s.io/api/rbac/v1"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// -----------------------------------------------------------------------------
// ClusterRole generator
// -----------------------------------------------------------------------------

// GenerateNewClusterRoleForControlPlane_{{.Version}} is a helper to generate a ClusterRole
// resource with all the permissions needed by the controlplane deployment.
// It is used for controlplanes that match the semver constraint "{{.Constraint}}"
func GenerateNewClusterRoleForControlPlane_{{.Version}}(controlplaneName string) *rbacv1.ClusterRole {
	return &rbacv1.ClusterRole{
		ObjectMeta: metav1.ObjectMeta{
			GenerateName: fmt.Sprintf("%s-", controlplaneName),
			Labels: map[string]string{
				"app": controlplaneName,
			},
		},
		Rules: []rbacv1.PolicyRule{
			{{ range .Roles }}
			{{ range .Rules }}
			{
				APIGroups: []string{
					{{ range .APIGroups }}"{{.}}",{{end}}
				},
				Resources: []string{
					{{ range .Resources }}"{{.}}",{{end}}
				},
				Verbs: []string{
					{{ range .Verbs }}"{{.}}",{{end}}
				},
			},
			{{- end }}
			{{- end }}
		},
	}
}

`

	kicRBACHelperTemplate = `// This file is generated by /hack/generators/kic-clusterrole-generator. DO NOT EDIT.

package resources

import (
	"fmt"

	"github.com/Masterminds/semver"
	rbacv1 "k8s.io/api/rbac/v1"

	"github.com/kong/gateway-operator/internal/consts"
	"github.com/kong/gateway-operator/internal/utils/kubernetes/resources/clusterroles"
	"github.com/kong/gateway-operator/internal/versions"
)

// -----------------------------------------------------------------------------
// ClusterRole generator helper
// -----------------------------------------------------------------------------

// GenerateNewClusterRoleForControlPlane is a helper function that extract
// the version from the tag, and returns the ClusterRole with all the needed
// permissions.
func GenerateNewClusterRoleForControlPlane(controlplaneName string, image string) (*rbacv1.ClusterRole, error) {
	versionToUse := versions.DefaultControlPlaneVersion 
	imageToUse := consts.DefaultControlPlaneImage
	var constraint *semver.Constraints

	if image != "" {
		v, err := versions.FromImage(image)
		if err != nil {
			return nil, err
		}
		supported, err := versions.IsControlPlaneImageVersionSupported(image)
		if err != nil {
			return nil, err
		}
		if supported {
			imageToUse = image
			versionToUse = v.String()
		}
	}

	semVersion, err := semver.NewVersion(versionToUse)
	if err != nil {
		return nil, err
	}

	{{ range $constraint, $suffix := .Versions}}
	constraint, err = semver.NewConstraint("{{$constraint}}")
	if err != nil {
		return nil, err
	}
	if constraint.Check(semVersion){
		return clusterroles.GenerateNewClusterRoleForControlPlane_{{$suffix}}(controlplaneName), nil
	}	
	{{ end}}
	return nil, fmt.Errorf("version %s not supported", imageToUse)
}

`
)
